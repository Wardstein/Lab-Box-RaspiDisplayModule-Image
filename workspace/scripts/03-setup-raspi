set -x
set -e

export LC_ALL=C

source /common.sh
install_cleanup_trap

# Scripts run as root by default

# raspi-config cli documentation
# https://www.raspberrypi.com/documentation/computers/configuration.html#raspi-config-cli


# Add the default user
adduser --gecos "" --disabled-password $RASPI_USER
chpasswd <<<"$RASPI_USER:$RASPI_PASSWORD"
usermod -a -G users,adm,dialout,audio,netdev,video,plugdev,cdrom,games,input,gpio,spi,i2c,render,sudo $RASPI_USER
# Show a control output which groups the user is in
groups $RASPI_USER

# Make sure user doesn't require a password when running as sudo; https://github.com/Pioreactor/CustoPiZer/blob/pioreactor/workspace/scripts/01-make-pioreactor-user.sh
echo "$RASPI_USER ALL=(ALL) NOPASSWD: ALL" | sudo EDITOR='tee -a' visudo -f /etc/sudoers.d/010_$RASPI_USER-nopasswd


# https://github.com/gitbls/sdm/blob/master/plugins/disables#L90
systemctl disable triggerhappy.service 
systemctl disable triggerhappy.socket
[ -f /lib/udev/rules.d/60-triggerhappy.rules ] && mv /lib/udev/rules.d/60-triggerhappy.rules /lib/udev/rules.d/.60-triggerhappy-save.rules
[ -f /usr/sbin/thd ] && mv /usr/sbin/thd /usr/sbin/thd.save

systemctl disable dphys-swapfile.service
systemctl disable userconfig.service
apt purge -y piwiz

# Just unistalling pywiz does not solve the startup. We boot into "rpi-first-boot-wizard" user
# https://forums.raspberrypi.com/viewtopic.php?p=2036168&sid=7e348ea4c90ad0c51def1eb973b20258#p2036168
[ -f /etc/xdg/autostart/piwiz.desktop ] && mv /etc/xdg/autostart/piwiz.desktop /etc/xdg/autostart/.piwiz.desktop.save
systemctl disable userconfig.service > /dev/null 2>&1
systemctl mask    userconfig.service > /dev/null 2>&1
[ "$(getent passwd rpi-first-boot-wizard)" != "" ] && userdel -r rpi-first-boot-wizard > /dev/null 2>&1
[ -f /etc/systemd/system/getty@tty1.service.d/autologin.conf ] && mv /etc/systemd/system/getty@tty1.service.d/autologin.conf /etc/systemd/system/getty@tty1.service.d/.autologin.conf.save
rm -f /etc/sudoers.d/010_wiz-nopasswd
rm -f /etc/xdg/autostart/deluser.desktop


# Create a one-time setup file
FIRSTBOOT_FILE="/firstboot.sh"
rm -f $FIRSTBOOT_FILE

echo -e "#!/bin/bash\n\nset -e\n\n" > $FIRSTBOOT_FILE

# Stolen from the Raspberry Pi Imager software
###echo $RASPI_HOSTNAME > /etc/hostname
###CURRENT_HOSTNAME=`cat /etc/hostname | tr -d \" \\t\\n\\r\"`
###sed -i \"s/127.0.1.1.*$CURRENT_HOSTNAME/127.0.1.1\\t"+$RASPI_HOSTNAME+"/g\" /etc/hosts
#raspi-config nonint do_hostname $RASPI_HOSTNAME
echo "raspi-config nonint do_hostname $RASPI_HOSTNAME" >> $FIRSTBOOT_FILE

# Enable SSH for login
###systemctl enable ssh
#raspi-config nonint do_ssh 0
echo "raspi-config nonint do_ssh 0" >> $FIRSTBOOT_FILE

# Enable VNC server
#raspi-config nonint do_vnc 0
echo "raspi-config nonint do_vnc 0" >> $FIRSTBOOT_FILE

# Boot to desktop, logging in automatically
#raspi-config nonint do_boot_behaviour B4
# DOES NOT SEEM TO WORK AS IT CANNOT FIGURE OUT THE USER, SEE SOLUTION ON BOTTOM
#echo "raspi-config nonint do_boot_behaviour B4" >> $FIRSTBOOT_FILE

# Disable screen blanking
#raspi-config nonint do_blanking
echo "raspi-config nonint do_blanking" >> $FIRSTBOOT_FILE

# Enable predictable network interface names
#raspi-config nonint do_net_names 0
echo "raspi-config nonint do_net_names 0" >> $FIRSTBOOT_FILE

# Hardware interfaces like SPI, I2C and Serial are already set in the config.txt file in a prior CustoPiZer step

echo "systemctl daemon-reload" >> $FIRSTBOOT_FILE
echo "sed -i 's| systemd.run.*||g' /boot/cmdline.txt" >> $FIRSTBOOT_FILE
echo "rm -f $FIRSTBOOT_FILE" >> $FIRSTBOOT_FILE
echo "exit 0" >> $FIRSTBOOT_FILE

cat $FIRSTBOOT_FILE
echo -n " systemd.run=$FIRSTBOOT_FILE systemd.run_success_action=reboot systemd.unit=kernel-command-line.target">>/boot/cmdline.txt
cat /boot/cmdline.txt



# ENABLE AUTOLOGIN, FIX FROM raspi-config LINE ABOVE
# Stolen from the raspi-config tool: https://github.com/RPi-Distro/raspi-config/blob/bookworm/raspi-config#L1686; Same also mentioned here: https://raspberrypi.stackexchange.com/a/136099
sed /etc/lightdm/lightdm.conf -i -e "s/^\(#\|\)autologin-user=.*/autologin-user=$RASPI_USER/"
cat > /etc/systemd/system/getty@tty1.service.d/autologin.conf << EOF
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin $RASPI_USER --noclear %I \$TERM
EOF
